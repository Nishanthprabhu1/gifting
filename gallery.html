<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    <style>
        body { margin: 0; overflow: hidden; font-family: 'Poppins', sans-serif; }
        
        /* HIDE VR BUTTONS */
        .a-enter-vr, .a-enter-ar { display: none !important; }

        .tilt-guide {
            position: absolute; bottom: 40px; width: 100%;
            display: none; flex-direction: column; align-items: center;
            z-index: 1000; color: #D4AF37;
        }
        
        .tilt-icon { font-size: 30px; animation: tilt-move 2s infinite ease-in-out; }
        @keyframes tilt-move { 0% { transform: rotate(-15deg); } 50% { transform: rotate(15deg); } 100% { transform: rotate(-15deg); } }

        .counter {
            background: rgba(94, 15, 139, 0.8); color: white;
            padding: 8px 20px; border-radius: 30px; margin-top: 10px;
            font-size: 14px; border: 1px solid #D4AF37;
        }

        #permission-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .perm-btn { padding: 15px 30px; background: #5E0F8B; color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

    <div id="permission-screen">
        <p style="color: white; text-align: center;">To use Tilt Navigation,<br>we need sensor access.</p>
        <button class="perm-btn" onclick="requestMotionPermission()">Start Experience</button>
    </div>

    <div class="tilt-guide" id="guide">
        <div class="tilt-icon">ðŸ“±</div>
        <div class="counter" id="imgCounter">1 / 5</div>
    </div>

    <a-scene 
        mindar-image="imageTargetSrc: ./targets.mind; targetIndex: 1;" 
        vr-mode-ui="enabled: false" 
        device-orientation-permission-ui="enabled: false">
        
        <a-assets id="assets-list"></a-assets>

        <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

        <a-entity mindar-image-target="targetIndex: 1" id="gift-target">
            <a-image id="display-img" 
                     src="assets/pic1.jpg" 
                     position="0 0 0"
                     animation__slide="property: position; from: -0.3 0 0; to: 0 0 0; dur: 500; startEvents: slide-left"
                     animation__slideright="property: position; from: 0.3 0 0; to: 0 0 0; dur: 500; startEvents: slide-right"
                     animation__fade="property: material.opacity; from: 0; to: 1; dur: 500; startEvents: slide-left, slide-right">
            </a-image>
        </a-entity>
    </a-scene>

    <script>
        const pics = ["assets/pic1.jpg", "assets/pic2.jpg", "assets/pic3.jpg", "assets/pic4.jpg", "assets/pic5.jpg"];
        let currentIdx = 0;
        let canTilt = true; 

        const imgEl = document.querySelector('#display-img');
        const targetEl = document.querySelector('#gift-target');
        const guide = document.querySelector('#guide');
        const counterEl = document.querySelector('#imgCounter');

        targetEl.addEventListener('targetFound', () => { guide.style.display = 'flex'; });
        targetEl.addEventListener('targetLost', () => { guide.style.display = 'none'; });

        // --- AUTO-RATIO LOGIC ---
        function adjustRatio(imgUrl) {
            const tempImg = new Image();
            tempImg.onload = function() {
                const originalWidth = this.width;
                const originalHeight = this.height;
                const ratio = originalHeight / originalWidth;
                
                // Set base width (e.g., 0.8) and calculate height based on ratio
                const newWidth = 0.8; 
                const newHeight = newWidth * ratio;
                
                imgEl.setAttribute('width', newWidth);
                imgEl.setAttribute('height', newHeight);
            };
            tempImg.src = imgUrl;
        }

        // Initialize first image ratio
        adjustRatio(pics[0]);

        function requestMotionPermission() {
            if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission().then(state => {
                    if (state === 'granted') window.addEventListener('deviceorientation', handleTilt);
                });
            } else {
                window.addEventListener('deviceorientation', handleTilt);
            }
            document.getElementById('permission-screen').style.display = 'none';
        }

        function handleTilt(event) {
            if (!canTilt) return;
            let tilt = event.gamma; 

            if (tilt > 25) { 
                canTilt = false;
                currentIdx = (currentIdx + 1) % pics.length;
                imgEl.emit('slide-right');
                updateContent();
            } 
            else if (tilt < -25) { 
                canTilt = false;
                currentIdx = (currentIdx - 1 + pics.length) % pics.length;
                imgEl.emit('slide-left');
                updateContent();
            }
        }

        function updateContent() {
            const nextImg = pics[currentIdx];
            adjustRatio(nextImg); // Calculate new ratio for the new image
            imgEl.setAttribute('src', nextImg);
            counterEl.innerText = `${currentIdx + 1} / ${pics.length}`;
            if (window.navigator.vibrate) window.navigator.vibrate(50);
            setTimeout(() => { canTilt = true; }, 800);
        }
    </script>
</body>
</html>