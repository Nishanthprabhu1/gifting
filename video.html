<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #000; }
        .ui { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 100; display: none; }
        .btn { padding: 12px 24px; background: #5E0F8B; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .back { position: absolute; top: 10px; left: 10px; z-index: 100; color: white; text-decoration: none; background: rgba(0,0,0,0.5); padding: 5px 10px; border-radius: 5px; font-size: 12px; }
    </style>
</head>
<body>
    <a href="index.html" class="back">üè† Back to Menu</a>
    <div class="ui" id="ui-panel"><button class="btn" id="play-btn">‚ñ∂Ô∏è Play Video</button></div>
    
    <a-scene mindar-image="imageTargetSrc: ./targets.mind; targetIndex: 0; filterMinCF:0.0001; filterBeta: 0.001;" 
             vr-mode-ui="enabled: false" device-orientation-permission-ui="enabled: false">
        
        <a-assets>
            <video id="vid" src="assets/video1.mp4" loop="true" crossorigin="anonymous" playsinline webkit-playsinline muted></video>
        </a-assets>

        <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

        <a-entity mindar-image-target="targetIndex: 0" id="target">
            <a-entity id="video-screen"
                geometry="primitive: plane; width: 1; height: 1"
                material="shader: chromakey; src: #vid; color: 0.1 0.9 0.1; threshold: 0.3; smoothness: 0.05">
            </a-entity>
        </a-entity>
    </a-scene>

    <script>
        // --- CHROMA KEY SHADER ---
        AFRAME.registerShader('chromakey', {
            schema: {
                src: {type: 'map'},
                color: {type: 'color', default: '#00FF00'},
                threshold: {type: 'number', default: 0.3},
                smoothness: {type: 'number', default: 0.05}
            },
            init: function(data) {
                this.material = new THREE.ShaderMaterial({
                    uniforms: {
                        tex: {value: null},
                        keyColor: {value: new THREE.Color(data.color)},
                        similarity: {value: data.threshold},
                        smoothness: {value: data.smoothness}
                    },
                    vertexShader: `
                        varying vec2 vUv;
                        void main() {
                            vUv = uv;
                            gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
                        }
                    `,
                    fragmentShader: `
                        uniform sampler2D tex;
                        uniform vec3 keyColor;
                        uniform float similarity;
                        uniform float smoothness;
                        varying vec2 vUv;
                        void main() {
                            vec4 videoColor = texture2D(tex, vUv);
                            float diff = distance(videoColor.rgb, keyColor);
                            float alpha = smoothstep(similarity, similarity + smoothness, diff);
                            if (alpha < 0.1) discard; 
                            gl_FragColor = vec4(videoColor.rgb, alpha);
                        }
                    `,
                    transparent: true
                });
            },
            update: function(data) {
                if (data.src) this.material.uniforms.tex.value = data.src;
            }
        });

        // --- CONTROLS ---
        const video = document.querySelector('#vid');
        const target = document.querySelector('#target');
        const ui = document.querySelector('#ui-panel');
        const btn = document.querySelector('#play-btn');

        target.addEventListener('targetFound', () => {
            ui.style.display = 'block';
        });

        target.addEventListener('targetLost', () => {
            ui.style.display = 'none';
            video.pause();
        });

        btn.addEventListener('click', () => {
            if (video.paused) {
                video.muted = false; // Unmute only when user clicks
                video.play();
                btn.innerText = "‚è∏ Pause Video";
            } else {
                video.pause();
                btn.innerText = "‚ñ∂Ô∏è Play Video";
            }
        });
    </script>
</body>
</html>